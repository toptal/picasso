#!/usr/bin/env bash

BLUE='\033[0;34m'
NC='\033[0m'
PICASSO_IMAGE='picasso'
PKG_VERSION=`node -p "require('./package.json').version"`
GIT_SHA=`git rev-parse --short=8 HEAD`

if [[ "$(docker images -q $PICASSO_IMAGE:$PKG_VERSION 2> /dev/null)" == "" ]]; then
  docker build -t $PICASSO_IMAGE:$PKG_VERSION .
else
  echo -e "${BLUE} Docker image found: '$PICASSO_IMAGE:$PKG_VERSION' ${NC}" 
fi

DOCKER_CMD="docker run -t -i --rm --name $PICASSO_IMAGE \
 -v ${PWD}/package.json:/app/package.json \
 -v ${PWD}/yarn.lock:/app/yarn.lock \
 -v ${PWD}/src:/app/src \
 -v ${PWD}/build:/app/build \
 -v ${PWD}/puppeteer:/app/puppeteer \
 -v ${PWD}/.storybook:/app/.storybook \
 -v ${PWD}/bin:/app/bin \
 -v ${PWD}/__diff_output__:/app/__diff_output__ \
 -e NPM_TOKEN=$NPM_TOKEN \
 -e GIT_SHA=$GIT_SHA \
 $PICASSO_IMAGE:$PKG_VERSION"

echo -e "${BLUE} Running command inside docker ... ${NC}"

set -x
$DOCKER_CMD "$@"
exit $?
