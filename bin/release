#!/usr/bin/env sh
CWD="$(dirname "$0")"	
cd "$CWD/../"
BASE_PATH=$(pwd)

NODE_MODULES="$BASE_PATH/node_modules/"

# Build all packages
npx lerna run build:dist

# Publish packages
if [[ $RELEASE_AND_PUBLISH == "1" ]]; then
  echo "=== WARNING RUNNING LIVE RELEASE FOR PACKAGES ==="
  $NODE_MODULES/.bin/lerna publish --contents build --canary
else
  echo "=== RUNNING TEST RELEASE FOR PACKAGES. NOTHING WILL BE PUBLISHED ==="
  $NODE_MODULES/.bin/lerna changed
fi

# Send data about published packages to jenkins
$NODE_MODULES/.bin/lerna changed -l > /artifacts/.version
