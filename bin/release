#!/usr/bin/env sh
CWD="$(dirname "$0")"	
cd "$CWD/../"
BASE_PATH=$(pwd)

NODE_MODULES="$BASE_PATH/node_modules/"

# Needs to be updated for publishing package to npm	
echo '//registry.npmjs.org/:_authToken=${NPM_TOKEN} \	
always-auth=true ' > .npmrc	
git update-index --assume-unchanged .npmrc

# Build all packages
npx lerna run build:dist

git config user.email "$GIT_COMMITTER_EMAIL"
git config user.name "$GIT_COMMITTER_NAME"

# Publish packages
if [[ $RELEASE_AND_PUBLISH == "1" ]]; then
  echo "=== WARNING RUNNING LIVE RELEASE FOR PACKAGES ==="
  $NODE_MODULES/.bin/lerna publish --contents build
else
  echo "=== RUNNING TEST RELEASE FOR PACKAGES. NOTHING WILL BE PUBLISHED ==="
  $NODE_MODULES/.bin/lerna changed
fi

# Send data about published packages to jenkins
npx lerna changed --json | jq '.[] | .name + "-" + .version' | xargs echo > /artifacts/.version
