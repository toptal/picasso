#!/usr/bin/env node
/* eslint-disable no-console  */

const path = require('path')
const yargs = require('yargs').argv
const sh = require('shelljs')
const exec = require('child_process').execSync

const { log, generatePackageJson } = require('./utils')
const tscPath = path.resolve(__dirname, '../node_modules/.bin/tsc')

const safeExec = cmd => {
  try {
    exec(
      cmd,
      { stdio: [process.stdin, process.stdout, process.stderr] },
      (error, stdout) => {
        if (error) {
          process.exit(1)
        } else {
          return stdout
        }
      }
    )
  } catch (e) {
    console.error(e.message)
    process.exit(1)
  }
}

const compile = function (tsConfig, packageJson) {
  const args = []

  log(`Building ${packageJson.name}:${packageJson.version}`)

  function build () {
    const cmd = `${tscPath} -p tsconfig.json ${args.join(' ')}`

    safeExec(cmd)
    log(`Build ready in: ${tsConfig.compilerOptions.outDir}`, 'green')
  }

  function clean () {
    log(`Removing: ${tsConfig.compilerOptions.outDir}`, 'green')
    sh.rm('-rf', tsConfig.compilerOptions.outDir)
  }

  clean()
  build()

  generatePackageJson(packageJson, outputPackageJson, entry)

  if (yargs.watch) {
    args.unshift('--watch')
    log(`Watching for changes in: ${tsConfig.include.join(', ')}`)
    build()
  }
}

const tsConfig = require(path.resolve(yargs.tsConfig))
const packageJson = require(path.resolve(yargs.packageJson))
const outputPackageJson = yargs.outputPackageJson || tsConfig.compilerOptions.outDir
const entry = yargs.entry || './index.js'

compile(tsConfig, packageJson)
