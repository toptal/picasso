name: Publish Packages to NPM
description: |
  Routes package publishing to the appropriate workflow. Trusted publishing is
  tied to a single workflow, this is why the central publishing workflow is needed.

on:
  # Publish updated packages on master branch push
  push:
    branches:
      - master
  # Publish alpha packages on pull request comment
  issue_comment:
    types: [created]

permissions:
  contents: write
  id-token: write
  issues: write
  pull-requests: write
  statuses: write

jobs:
  publish-updated-packages:
    name: Publish updated packages to NPM
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        # Same as actions/checkout@v5
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Trigger updated packages publishing
        uses: ./.github/actions/build-publish-updated-package
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  log-commenter-info:
    name: Log commenter info
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issue_comment' }}
    steps:
      - name: Log commenter info
        run: |
          echo "Commenter: ${{ github.event.comment.user.login }}"
          echo "Commenter ID: ${{ github.event.comment.user.id }}"
          echo "Comment: ${{ github.event.comment.body }}"
          echo "Association: ${{ github.event.comment.author_association }}"

  publish-alpha-packages:
    name: Publish alpha packages to NPM
    # TODO: will be restricted later
    if: false
    #if: ${{ github.event_name == 'issue_comment' && github.event.comment.body == '@toptal-bot run package:alpha-release' }}
    runs-on: ubuntu-latest
    env:
      STATUS_CHECK_NAME: Publish Alpha Package
      STATUS_TARGET_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Get branch info
        id: branch
        # Same as xt0rted/pull-request-comment-branch@v2.0.0
        uses: xt0rted/pull-request-comment-branch@d97294d304604fa98a2600a6e2f916a84b596dc7

      - name: Check out code
        # Same as actions/checkout@v5
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          ref: ${{ steps.branch.outputs.head_ref }}
          fetch-depth: 0

      - name: Set status check - pending
        # Same as actions/github-script@v7
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.issue;
            await github.rest.repos.createCommitStatus({
              repo,
              owner,
              state: 'pending',
              sha: "${{ steps.branch.outputs.head_sha }}",
              context: process.env.STATUS_CHECK_NAME,
              target_url: process.env.STATUS_TARGET_URL
            })

      - name: Add reaction to issue comment
        # Same as actions/github-script@v7
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.issue;
            await github.rest.reactions.createForIssueComment({
              owner,
              repo,
              comment_id: context.payload.comment.id,
              content: '+1'
            });

      - name: Trigger alpha packages publishing
        id: alpha-package
        uses: ./.github/actions/build-publish-alpha-package
        with:
          branch: ${{ steps.branch.outputs.head_ref }}
          root-folder: '.'

      - name: Post comment with package versions
        if: ${{ success() }}
        # Same as actions/github-script@v7
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        env:
          versions: ${{ steps.alpha-package.outputs.versions }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo: { owner, repo }, issue } = context
            const { versions } = process.env

            const body = "Your alpha package is ready ðŸŽ‰<br/>" + versions.split(' ').reduce((acc, version) => {
              acc += `\`yarn add ${version}\`<br/>`
              return acc
            }, '')

            await github.rest.issues.createComment({ issue_number: issue.number, owner, repo, body })

      - name: Set status check - success / failure / error
        # Same as actions/github-script@v7
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.issue;

            const status = "${{ job.status }}";
            const state = status === 'cancelled' ? 'error' : status;

            await github.rest.repos.createCommitStatus({
              repo,
              owner,
              state,
              sha: "${{ steps.branch.outputs.head_sha }}",
              context: process.env.STATUS_CHECK_NAME,
              target_url: process.env.STATUS_TARGET_URL
            })
