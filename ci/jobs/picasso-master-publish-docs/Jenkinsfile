@Library('globalLibrary@master') _
pipeline {

  agent { label 'docker' }

  options {
    ansiColor('xterm')
    timestamps()
    timeout(time: 1, unit: 'HOURS')
  }

  parameters {
    string(name: 'BRANCH', defaultValue: 'master', description: 'Branch or tag to build')
    string(name: 'PR_ID', defaultValue: '1', description: 'Pull request id')
  }

  environment {
    NPM_TOKEN = credentials('npm-token-for-toptal-private-registry')
    GITHUB_TOKEN = credentials('toptal-devbot-token-github-notify')
  }

  stages {
    stage("Git checkout branch") {
      steps {
        info "== Checking out Picasso"
        gitCheckout(
                branches: params.BRANCH,
                credentials: [username: 'git', description: 'jenkins/picasso'],
                url: 'git@github.com:toptal/picasso.git',
                additionalBehaviours: [
                        cleanBeforeCheckout: true
                ])

        info "Git commit: ${gitCommit()}"
        info "Git branch: ${gitBranch()}"
        success "Checkout finished"
      }
    }//stage

    stage('Build docs') {
        steps {
            script {
                sh """
                      docker run --tty -e NPM_TOKEN=$NPM_TOKEN -e HOME=`pwd` --volume `pwd`:`pwd`:z --user `id -u`:`id -g` \\
                      --workdir `pwd` node:8-alpine sh -c 'yarn install && yarn build:storybook'
                   """
            }//script
        }//steps
    }//stage
    stage('Sync docs to docs server') {
      steps {
        script {
            if (params.BRANCH == 'master') {
                target = ''
            } else {
                target = params.BRANCH
            }
            sh """
                 rsync -avz --delete -e ssh ./build/storybook/ docs@docs.staging.toptal.net:~/docs/picasso/${target} && \\
                 rm -rf ./build
               """
            if (params.BRANCH != 'master') {
                def comment = "Successfully deployed demo at https://picasso.toptal.net/${params.BRANCH}"
                gitHubPostComment('picasso', params.PR_ID, comment, env.GITHUB_TOKEN)
            }
        }//script
        script {
            VERSION = sh(returnStdout: true, script: 'cat package.json | jq ".version" -r').trim()
        }
      }//steps
    }//stage

  }//stages
}//pipeline
